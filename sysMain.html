<!DOCTYPE html>
<head>
	<link rel="stylesheet" type="text/css" href="basic.css">
	<title>Sr.Especialista</title>
</head>



<body>

	<div class="card">
		<h3>Perfil: <span id="txtUsuario">--</span></h3>
		As informações desse perfil estão disponíveis para qualquer pessoa
		<br><br>
		<button id="btSairPerfil">Sair</button>
		<button id="btSairPerfil">Alterar informacoes</button>
		
	</div>

	<div class='card'>
		<h3>Especialidade: <span id="txtSistema">--</span></h3>
		<p id="txtDescricao"></p>
		<br>
		<button id="btSair">Sair</button>
		<button id="btEdit">Editar informações</button>
	</div>

	<div class="card grow flex-1col">
		<h3>Fazer uma consulta</h3>
		<p>Escolha um ou mais items a determinar</p>
		<br>
		<select multiple id='slcObjetivos' size=5 class='grow-1'></select>
		<div>
			<button id='btConsultar'>Consultar</button>
			<button id='btFecharConsulta'>Fechar Consulta</button>
		</div>
	</div>

	<div class="card flex-1col" id='cardPerguntas' style='display: none'>
		<h3>Responda às questões abaixo</h3>
		<div id="formDiv"></div>
	</div>

	<div class="card flex-1col" id='cardResultados' style='display: none'>
		<h3>Resultados</h3>
		<div id="divResultados"></div>
	</div>

</body>



<script>
// =========================================================================
// REQUIRE
// =========================================================================
const { remote } = require('electron')
const dal = remote.require('./data-access-layer.js')
const thisWin = remote.getCurrentWindow()
const menu = require('./menu.js')



// =========================================================================
// ESTADO INICIAL DO PROCESSAMENTO
// =========================================================================
let tabelaConclusao = {}
let tabelaPerguntas = {}



// =========================================================================
// SETUP DE ELEMENTOS DA GUI
// =========================================================================
const txtUsuario = document.getElementById("txtUsuario")
const txtSistema = document.getElementById("txtSistema")
const txtDescricao = document.getElementById("txtDescricao")
const divResultados = document.getElementById('divResultados')
const formDiv = document.getElementById('formDiv')
const cardPerguntas = document.getElementById('cardPerguntas')
const cardResultado = document.getElementById('cardResultados')

const btSair = document.getElementById("btSair")
btSair.addEventListener('click',clickBtSair)

const btEdit = document.getElementById('btEdit') 
btEdit.addEventListener('click',clickBtEdit)

const btConsultar = document.getElementById('btConsultar')
btConsultar.addEventListener('click',clickBtConsultar)

const btFecharConsulta = document.getElementById('btFecharConsulta')
btFecharConsulta.addEventListener('click',clickBtFecharConsulta)


// =========================================================================
// ESTADO INICIAL DA UI
// =========================================================================
txtUsuario.innerHTML = dal.getPerfilAtivo().nome
txtSistema.innerHTML = dal.getSistemaAtivo().nome
txtDescricao.innerHTML = dal.getSistemaAtivo().descricao;

btFecharConsulta.disabled = true;

(async function inflarSlcObjetivos() {
	let slcObjetivos = document.getElementById('slcObjetivos')
	let objetivosConsultaveis = await dal.fetchAll('objetivos_consultaveis')
	console.log({objetivosConsultaveis})
	for( let item of objetivosConsultaveis ) {
		let opt = document.createElement('option')
		opt.text = item.objetivo
		opt.value = item.id
		slcObjetivos.options.add( opt )
	}
})()



// =========================================================================
// FUNCOES DE EVENTOS DA GUI
// =========================================================================
function clickBtSair(){
	thisWin.loadFile('./sysSelect.html')
}

function clickBtEdit() {
	thisWin.loadFile('./sysEdit.html')
}

function changeResposta(perguntaID, respostaID) {
	atualizarTabelaPerguntas( perguntaID, respostaID )
	atualizarCardResultados()
}

async function clickBtConsultar() {
	await criarTabelas()
	renderizarPerguntas()
	btFecharConsulta.disabled = false
}

function clickBtFecharConsulta() {
	cardPerguntas.style.display = 'none'
	cardResultados.style.display = 'none'
	btFecharConsulta.disabled = true
}




// =========================================================================
// FUNCOES DE ALTERACAO DA GUI
// =========================================================================
function renderizarPerguntas() {
	let formText = ''
	for( let p in tabelaPerguntas ) {
		let objetivosTexto = Object.values(tabelaPerguntas[p].objetivos).join('\n')
		formText += tabelaPerguntas[p].pergunta_txt
		formText += `<span class='info-mark' title='Esta pergunta ajuda a determinar:\n${objetivosTexto}'> <a href='#'>( ? )</a></span>`
		formText += `<br><select id='pergunta_${p}' onChange='changeResposta(${p},this.value)'>`
		
		let respostas = tabelaPerguntas[p].respostas_possiveis
		let options = ''
		for( let rID in respostas ) {
			options += `<option value='${rID}'>${respostas[rID]}</option>`
		}
		formText += `<option value=null> -- </option> ${options}</select><br>`
	}
	formDiv.innerHTML = formText
	if( formText.length > 0 ) cardPerguntas.style.display = 'flex'
}



function atualizarCardResultados() {
	let resultadoObj = {}
	let resultadoTexto = ''

	// Itera a tabelaConclusao verificando os grupos de perguntas que
	// foram respondidos de forma satisfazer as condicoes de conclusao
	// e adiciona os objetivos e conclusoes no objeto resultadoObj
	for( let cID in tabelaConclusao ) {
		let conc = tabelaConclusao[cID]
		let grupoMatch = true
		for( let gID in conc.grupos ) {
			for( p in conc.grupos[gID] ) {
				let perg = conc.grupos[gID][p]
				if( perg.resposta_certa != perg.tabelaPerguntas.resposta_usuario ) {
					grupoMatch = false
				}
			}
		}
		if( !resultadoObj[conc.objetivo_txt] ) resultadoObj[conc.objetivo_txt] = []
		if( grupoMatch ) resultadoObj[conc.objetivo_txt].push( conc.conclusao_txt )
	}
	
	// Itera o objeto resultadoObj jutando os valores na string resultadoTexto
	for( objetivo in resultadoObj ) {
		conclusao = resultadoObj[objetivo].join('\n')
		if( conclusao.length == 0 ) conclusao = 'Inconclusivo'
		resultadoTexto += `<br><p><b>${objetivo}:</b><br>${conclusao}</p>`
	}

	// atualiza a view
	divResultados.innerHTML = '<p>A partir das respostas fornecidas foi possível concluir o seguinte:</p>'
	divResultados.innerHTML += resultadoTexto
	cardResultado.style.display = 'flex'
	//console.log({resultadoObj})
}



// =========================================================================
// FUNCOES DE PROCESSAMENTO
// =========================================================================
async function fetchCondicoesUnrolled() {
	let objetivosIDs = []
	for( let opt of slcObjetivos.selectedOptions ) {
		objetivosIDs.push( opt.value )
	}
	return await dal.fetchAll('condicoes_unrolled',`objetivo_fk IN (${objetivosIDs.join(',')})`)
}



async function criarTabelas() {
	const condicoesUnrolled = await fetchCondicoesUnrolled()
	tabelaConclusao = {}
	tabelaPerguntas = {}

	// criando a o objeto tabela de perguntas
	for( let con of condicoesUnrolled ) {
		if( !tabelaPerguntas[con.pergunta_fk] ) {
			tabelaPerguntas[con.pergunta_fk] = {
				resposta_usuario: null,
				respostas_possiveis: {},
				objetivos: {}
			}
		}
		else {
			tabelaPerguntas[con.pergunta_fk].pergunta_txt = con.pergunta
			tabelaPerguntas[con.pergunta_fk].objetivos[con.objetivo_fk] = con.objetivo
		}
	}
	// adicionando respostas possiveis ao objeto tabela de perguntas
	let perguntasIDs = Object.keys(tabelaPerguntas).join(',')
	let respostasQres = await dal.fetchAll('respostas', `pergunta_fk IN (${perguntasIDs})`)
	for( let row of respostasQres ) {
		//console.log({respostasQres})
		tabelaPerguntas[row.pergunta_fk].respostas_possiveis[row.id] = row.resposta
	}

	// construindo o objeto tabela de conclusoes
	let tc, g
	for( let con of condicoesUnrolled ) {
		if( !tabelaConclusao[con.conclusao_fk] ) {
			tabelaConclusao[con.conclusao_fk] = {}
		}
		tc = tabelaConclusao[con.conclusao_fk]
		tc.conclusao_txt = con.conclusao
		tc.objetivo_id = con.objetivo_fk
		tc.objetivo_txt = con.objetivo
		if( !tc.grupos ) tc.grupos = {}
		if( !tc.grupos[con.grupo] ) tc.grupos[con.grupo] = {}
		g = tc.grupos[con.grupo]
		g[`pergunta_${con.pergunta_fk}`] = {
			resposta_certa: con.resposta_fk,
			tabelaPerguntas: tabelaPerguntas[con.pergunta_fk]
		}
	}

	return
}



function atualizarTabelaPerguntas( perguntaID,respostaID ) {
	//alert(`${perguntaID} -  ${respostaID}`)
	tabelaPerguntas[perguntaID].resposta_usuario = respostaID
}


/*
TESTE DO RowsToObject

let RowsToObject = require('./RowsToObject')
let modelObject = {
	objetivo__objetivo_fk: {
		nome__: 'objetivo',
		conclusao__conclusao_fk: {
			nome__: 'conclusao',
			grupo__grupo: {
				pergunta__pergunta_fk: {
					nome__: 'pergunta',
					resposta__: {
						nome__: 'resposta',
						certa__: 'resposta_fk',
						usuario__: ['pegarResposta','resposta_fk',]
					}
				}
			}
		}
	}
}

dal.fetchAll('condicoes_unrolled')
.then(rows => {
	let obj = RowsToObject.formatToModel( rows, modelObject )
	console.log({obj})
})
*/

//rows=[[]], modelObjetc={}, modelFunctions={}, newObj={}, filters=[[]], maxDepth=10



</script>
</html>