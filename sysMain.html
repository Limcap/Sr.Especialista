<!DOCTYPE html>
<head>
	<link rel="stylesheet" type="text/css" href="basic.css">
	<title>Sr.Especialista</title>
</head>



<body>

	<div class="card">
		<h3>Perfil: <span id="txtUsuario">--</span></h3>
		As informações desse perfil estão disponíveis para qualquer pessoa
		<br><br>
		<button id="btSairPerfil">Sair</button>
		<button id="btSairPerfil">Alterar informacoes</button>
		
	</div>

	<div class='card'>
		<h3>Especialidade: <span id="txtSistema">--</span></h3>
		<p id="txtDescricao"></p>
		<br>
		<button id="btSair">Sair</button>
		<button id="btEdit">Editar informações</button>
	</div>

	<div class="card grow flex-v-1">
		<h3>Fazer uma consulta</h3>
		<p>Escolha um ou mais items a determinar</p>
		<br>
		<select id='slcObjetivos' size=5 class='grow-1'></select>
		<div>
			<button id='btConsultar'>Consultar</button>
		</div>
	</div>

	<div class="card">
		<h3>Responda às questões abaixo</h3>
		<div id="formDiv"></div>
	</div>

</body>



<script>
// ---------- Imports
const { remote } = require('electron')
const dal = remote.require('./data-access-layer.js')
const thisWin = remote.getCurrentWindow()


// ---------- Elementos do DOM
const btSair = document.getElementById("btSair")
const txtUsuario = document.getElementById("txtUsuario")
const txtSistema = document.getElementById("txtSistema")
const txtDescricao = document.getElementById("txtDescricao")
const btEdit = document.getElementById('btEdit') 


// ---------- Eventos
btSair.addEventListener('click',clickBtSair)
btEdit.addEventListener('click',clickBtEdit)


// ---------- Init
txtUsuario.innerHTML = dal.getPerfilAtivo().nome
txtSistema.innerHTML = dal.getSistemaAtivo().nome
txtDescricao.innerHTML = dal.getSistemaAtivo().descricao


// ---------- Funções
function clickBtSair(){
	thisWin.loadFile('./sysSelect.html')
}

function clickBtEdit() {
	thisWin.loadFile('./sysEdit.html')
}

(async function inflarSlcObjetivos() {
	let slcObjetivos = document.getElementById('slcObjetivos')
	let objetivosConsultaveis = await dal.fetchAll('objetivos_consultaveis')
	console.log({objetivosConsultaveis})
	for( let item of objetivosConsultaveis ) {
		let opt = document.createElement('option')
		opt.text = item.objetivo
		opt.value = item.id
		slcObjetivos.options.add( opt )
	}
})()

let btConsultar = document.getElementById('btConsultar')
btConsultar.addEventListener('click',carregarConsulta)

let tabelaPerguntas = {}
let tabelaResultado = {}

async function carregarConsulta() {
	let res = await dal.fetchAll('condicoes_unrolled')

	for( let con of res ) {
		tabelaPerguntas[con.pergunta_fk] = { 
			pergunta: con.pergunta,
			resposta: null
		}
	}

	for( let con of res ) {

		if( !tabelaResultado[`conclusao_${con.conclusao_fk}`] ) {
			tabelaResultado[`conclusao_${con.conclusao_fk}`] = {}
		}
		tabelaResultado[`conclusao_${con.conclusao_fk}`].conclusao_txt = con.conclusao
		tabelaResultado[`conclusao_${con.conclusao_fk}`].objetivo_id = con.objetivo_fk
		tabelaResultado[`conclusao_${con.conclusao_fk}`].objetivo_txt = con.objetivo
		if( !tabelaResultado[`conclusao_${con.conclusao_fk}`][`grupo_${con.grupo}`] ) {
			//console.log(`nao existe grupo_${con.grupo} na conclusao_${con.conclusao_fk}`)
			tabelaResultado[`conclusao_${con.conclusao_fk}`][`grupo_${con.grupo}`] = {}
		}
		//console.log(tabelaResultado.conclusao_8)
		tabelaResultado[`conclusao_${con.conclusao_fk}`][`grupo_${con.grupo}`][`pergunta_${con.pergunta_fk}`] = {
			resposta_certa: con.resposta_fk,
			resposta_fornecida: tabelaPerguntas[con.pergunta_fk]
		}
		/*
		tabelaResultado[con.conclusao_fk][`grupo_${con.grupo}`] = {}
		tabelaResultado[con.conclusao_fk][`grupo_${con.grupo}`][`pergunta_${con.pergunta_fk}`] = {
			resposta_certa: con.resposta_fk,
			resposta_fornecida: tabelaPerguntas[con.pergunta_fk]			
		}
		*/
		/*
		if( !tabelaResultado[con.conclusao_fk].grupos[con.grupo] ) {
			tabelaResultado[con.conclusao_fk].grupos[con.grupo] = {}
		}
		if( !tabelaResultado[con.conclusao_fk].grupos[con.grupo][con.pergunta_fk] ) {
			tabelaResultado[con.conclusao_fk].grupos[con.grupo][con.pergunta_fk]
		}
		tabelaResultado[con.conclusao_fk].grupos[con.grupo][con.pergunta_fk] = {
			resposta_certa: con.resposta_fk,
			resposta_fornecida: tabelaPerguntas[con.pergunta_fk]
		}
		*/
	}

	console.log({tabelaResultado})
	renderForm()
}

let formDiv = document.getElementById('formDiv')
function renderForm() {
	
	let formText = ''
	for( let p in tabelaPerguntas ) {
		console.log( p )
		formText += `${tabelaPerguntas[p].pergunta}<br><select id='pergunta_${p}'></select><br>`
	}
	formDiv.innerHTML = formText
}




</script>